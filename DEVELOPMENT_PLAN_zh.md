# 开发计划：医疗集成引擎（受 Mirth Connect 启发）

## 1. 项目目标
开发一个灵活可扩展的医疗集成引擎，类似于 Mirth Connect，能够促进不同医疗系统之间安全高效的数据交换。该引擎将专注于消息过滤、转换、提取和路由，以实现无缝的信息流。

## 2. 核心功能

### 2.1. 连接器管理
*   定义和管理各种类型的数据源/目标连接器（例如：文件、HTTP、数据库、HL7、FHIR）。
*   每种连接器类型的配置界面。

### 2.2. 消息处理管道
*   **消息摄取：** 从配置的输入连接器接收消息。
*   **消息过滤：** 根据内容、元数据或其他标准实现消息过滤规则。
*   **消息转换：** 提供工具用于在不同格式之间转换消息（例如：HL7 到 JSON、XML 到 FHIR、自定义格式）。
*   **消息路由：** 配置规则以根据定义的逻辑将处理后的消息路由到适当的输出连接器。
*   **消息输出：** 将转换后的消息发送到配置的输出连接器。

### 2.3. 数据持久化
*   存储消息日志、处理历史和配置数据。
*   支持消息流的审计和可追溯性。

### 2.4. 监控与日志
*   实时监控消息流和系统健康状况。
*   全面记录所有处理步骤、错误和警告。
*   关键事件的警报机制。

### 2.5. 用户界面（基于 Web）
*   直观的仪表板，显示系统整体状态。
*   连接器、过滤器、转换和路由规则的配置界面。
*   消息浏览器，用于查看历史消息和日志。
*   用户管理和访问控制。

## 3. 技术栈

*   **后端：** Python (FastAPI, SQLModel) - 利用现有 `LingShu-backend` 结构。
    *   潜在的补充：消息队列（例如：RabbitMQ, Kafka）用于异步处理和可伸缩性。
*   **前端：** React (遵循 Material Design 原则) - 利用现有 `LingShu-frontend` 结构。
*   **数据库：** SQLite（用于开发/小型部署），PostgreSQL（推荐用于生产）。
*   **消息/集成：**
    *   用于医疗标准（HL7、FHIR、DICOM - 随范围扩展）的自定义解析器/序列化器。
    *   模板引擎（例如：Jinja2）用于灵活的转换。

## 4. 分阶段开发

### 阶段 1：核心消息处理 (MVP)
*   **后端：**
    *   基本连接器框架（例如：文件系统输入/输出）。
    *   简单的消息直通逻辑。
    *   初始消息日志记录到数据库。
    *   基本连接器配置的 API 端点。
*   **前端：**
    *   用于列出和配置基本文件连接器的最小 UI。
    *   显示活动连接器的基本仪表板。

### 阶段 2：过滤和转换
*   **后端：**
    *   实现消息过滤逻辑（例如：基于简单正则表达式或 JSONPath）。
    *   开发基本的消息转换引擎（例如：使用 Python 脚本或 Jinja2 模板）。
    *   扩展 API 以定义过滤器和转换。
*   **前端：**
    *   用于定义和应用消息过滤器的 UI。
    *   用于创建和管理消息转换模板的 UI。

### 阶段 3：高级连接器和路由
*   **后端：**
    *   添加更多连接器类型（例如：HTTP 监听器/发送器、数据库读取器/写入器）。
    *   实现高级路由规则（例如：基于消息内容的条件路由）。
    *   与消息队列集成，实现健壮的异步处理和错误处理。
*   **前端：**
    *   用于配置新连接器类型的 UI。
    *   用于定义复杂路由逻辑的 UI。

### 阶段 4：监控和管理
*   **后端：**
    *   开发用于消息队列、连接器状态和处理指标的全面监控端点。
    *   实现用户身份验证和授权。
*   **前端：**
    *   详细的监控仪表板（消息吞吐量、错误率）。
    *   用户管理界面。
    *   警报配置。

### 阶段 5：医疗标准支持（未来扩展）
*   **后端：**
    *   实现 HL7 v2、FHIR 以及可能的 DICOM 的健壮解析器和序列化器。
    *   提供用于常见医疗消息转换的预构建模板和映射。
*   **前端：**
    *   用于配置 HL7/FHIR 特定转换的专用 UI 组件。

## 5. 测试策略
*   **单元测试：** 对所有后端逻辑（API 端点、消息处理组件、数据库交互）和前端组件进行全面的单元测试。
*   **集成测试：** 测试不同组件之间的交互（例如：连接器到消息处理器、处理器到数据库）。
*   **端到端测试：** 模拟从摄取到输出的完整消息流，验证数据完整性和正确路由。

## 6. 部署考虑
*   **容器化：** 将后端和前端应用程序 Docker 化，以便于部署和可移植性。
*   **编排：** 利用 Docker Compose 进行本地开发，并可能使用 Kubernetes 进行可伸缩的生产部署。
*   **配置管理：** 将配置外部化（例如：环境变量、`.env` 文件）以适应不同环境。
